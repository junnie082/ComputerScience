# Cyber Security 5

# 제 5 장. 블록 암호 모드

#### 2024.04.14.(일)

## 제 1 절 블록 암호 모드

### 1.1 블록 암호와 스트림 암호

- 블록 암호(block cipher)

  - 어느 특정 비트 수의 [집합]을 한 번에 처리하는 암호 알고리즘
    이 [집합]을 블록(block)

  - 블록의 비트 수를 블록 길이 (block length)
    - DES나 트리플 DES의 블록 길이는 64비트
    - DES: 64비트 평문, 64비트 암호문
    - AES: 블록 길이는 128비트, 192비트, 256비트

- 스트림 암호(stream cipher)는 데이터의 흐름(스트림)을 순차적으로 처리해가는 암호 알고리즘

- 1비트, 8비트, 혹은 32비트 등의 단위로 암호화 복호화

### 1.2 모드란?

- 모드란
  - 긴 평문을 블록으로 나누어 암호화
  - 각 블록에 암호 알고리즘을 반복해서 사용하여 긴 평문 전체를 암호화

### 블록암호 주요 모드

- ECB 모드: Electric CodeBook mode(전자 부호표 모드)
- CBC 모드: Cipher Block Chaining mode(암호 블록 연쇄 모드)
- CFB 모드: Cipher-FeedBack mode(암호 피드백 모드)
- OFB 모드: Output-FeedBack mode(출력 피드백 모드)
- CTR 모드: CounTeR mode(카운터 모드)

### 1.3 평문 블록과 암호문 블록

![47](/assets/images/2024-04-14/47.png)

- 평문 블록: 블록암호 알고리즘에서 암호화 대상이 되는 평문
- 암호문 블록: 블록암호 알고리즘을 써서 평문 블록을 암호화한 암호문

### 1.4 적극적인 공격자 멜로리

- 도청
- 위장
- 변조
- 적극적 공격자: 맬로리(Mallory)

## 제 2 절 ECB 모드

### 2.1 ECB 모드란?

- Electric CodeBook 모드

- 평문 블록을 암호화한 것이 그대로 암호문 블록

- 패딩(padding)
  - 마지막 평문 블록이 블록 길이에 미치지 못할 경우에 추가하여 블록 길이가 되도록 맞춤

![48](/assets/images/2024-04-14/48.png)

### 2.2 ECB 모드의 특징

- 기밀성이 가장 낮은 모드

- 암호문을 살펴보는 것만으로도 평문속의 패턴 반복성 감지 가능

- 안전하지 않음

### 2.3 ECB 모드에 대한 공격

- 어느 은행의 송금 의뢰 데이터가 다음 3개의 블록으로 구성

  - 블록1 = 송금자의 은행계좌번호
  - 블록2 = 송금처의 은행계좌번호
  - 블록3 = 송금액

- 송금 의뢰 데이터를 받은 은행은 지정된 금액을 송금자로부터 송금처의 계좌로 이동

- A-5374의 계좌로부터 B-6671의 계좌로 1억 원을 송금하라는 송금 의뢰 데이터를 만들어보자

- 원래: A-5374의 계좌에서 B-6671의 계좌로 1억 원을 송금하라는 지시
  -> B-6671의 계좌에서 A-5374의 계좌로 1억 원을 송금하라는 정반대의 지시로 `변조`

- 암호문 조작의 불법적 행위
  - 메세지 인증 코드 (9장) 병용하면 검출 가능
  - 다른 모드 사용

## 제 3 절 CBC 모드

### CBC 모드란?

- CBC 모드
  - Cipher Block Chaining 모드(암호 블록 연쇄 모드)의 약자
  - 암호문 블록을 마치 체인처럼 연결시키기 때문에 붙여진 이름
  - CBC 모드에서는 1 단계 앞에서 수행되어 결과로 출력된 암호문 블록에 평문 블록을 XOR 연산 후 암호화 수행
  - 각각의 암호문 블록은 단지 현재 평문블록 뿐만 아니라 그 이전의 평문 블록들의 영향도 받게됨

![49](/assets/images/2024-04-14/49.png)

### 3.2 초기화 벡터

- 초기화 벡터(IV: initialization vector)
  - 최초의 평문 블록을 암호화할 때
    [1 단계 앞의 암호문 블록]이 존재하지 않으므로
    [1 단계 앞의 암호문 블록]을 대신할 비트열인 한 개의 블록을 준비할 필요

### 3.3 CBC 모드의 특징

- 평문 블록은 반드시 [1단계 앞의 암호문 블록]과 XOR 연산 후 암호화
  -> 만약 평문 블록1과 2의 값이 같은 경우라도 암호문 블록1과 2의 값이 같아진다고는 할 수 없고, ECB 모드가 갖고 있는 결점이 CBC 모드에는 없음

- 암호문 블록3을 만들고 싶다면
  - 적어도 평문 블록의 1, 2, 3까지가 갖추어져 있어야 함

![50](/assets/images/2024-04-14/50.png)

![51](/assets/images/2024-04-14/51.png)

![52](/assets/images/2024-04-14/52.png)

### 3.5 패딩 오라클 공격

- 블록 암호의 패딩을 이용한 공격

  - 블록암호에서는 평문의 길이가 블록길이의 정수배가 되지 않을 때, 마지막 블록에 패딩이라는 데이터(의미 없는 값-보통 0)를 추가

- 패딩 내용을 조금씩 변화시켜 암호문을 여러 차례 송신

- 수신자가 올바로 복호화하지 못할 경우 오류를 관찰하여 평문 정보를 취득

- 패딩을 사용하는 모든 모드에 적용

- 공격자가 메세지의 패딩이 옳은지 아닌지의 여부를 판단하는 오라클이 있다면
  - 이 오라클을 이용하여 암호문에 대응하는 메세지를 알아낼 수 있음

### 3.6 초기화 벡터(IV) 공격

- 초기화 벡터는 난수(Random Number)로 부여

- SSL/TLS의 TLS 버전 1.0
  - 초기화 벡터를 이전 CBC 모드로 암호화한 마지막 블록을 사용
  - 문제점 발견 후 TLS 버전 1.1 부터는 초기화 벡터를 명시적으로 부여

### 3.7 CBC 모드 활용 예

- SSL/TLS:

  - 통신 기밀성 보호를 위해 CBC 모드를 사용

- 3DES-EDL-CBC

  - 트리플 DES를 CBC 모드로 사용

- AES-256-CBC

  - 키 길이가 256 비트인 AES를 CBC 모드로 사용

- IPsec에는 통신의 기밀성을 지키기 위해 CBC 모드를 사용

- 인증을 수행하는 대칭암호 시스템의 하나인 Kerberos version 5에서 사용

## 제 4 절 CFB 모드

### 4.1 CFB 모드

- CFB 모드
  - Cipher FeedBack 모드(암호 피드백 모드)의 약자
  - CFB 모드에서는 1단계 앞의 암호문 블록을 암호 알고리즘의 입력으로 사용

![53](/assets/images/2024-04-14/53.png)

### 4.2 초기화 벡터

- 초기화 벡터(IV)
  - 최초의 암호문 블록을 만들어낼 때는 1 단계 앞의 출력이 존재하지 않으므로 대신에 IV를 사용

![54](/assets/images/2024-04-14/54.png)

### 4.3 CFB 모드와 스트림 암호

- 키 스트림(key stream)

  - CFB 모드에서 암호 알고리즘이 생성하는 비트열
  - 키 스트림을 생성하기 위한 의사난수 생성기로서 암호 알고리즘을 이용
  - 초기화 벡터는 의사난수 생성기의 [seed]에 해당

- CFB 모드는 블록 암호를 써서 생성한 키를 이용하는 스트림 암호

### 4.4 CFB 모드의 복호화

- CFB 모드에서 복호화를 수행할 경우

  - 블록 암호 알고리즘 자체는 암호화를 수행하고 있다는 것에 주의

- 키 스트림은 암호화에 의해 생성

### 4.5 CFB 모드에 대한 공격

- 재전송 공격(replay attack)
  - 정당한 사용자에 의해 사용되는 정당한 데이터를 반복해서 발송하는 공격

![55](/assets/images/2024-04-14/55.png)

### 오늘 수신한 암호문의 복호화

![56](/assets/images/2024-04-14/56.png)

- 재전송 공격은 어떻게 해결하나?
  - 메세지 인증 코드

## 제 5 절 OFB 모드

### 5.1 OFB 모드란?

- OFB 모드
  - Output-FeedBack 모드(출력 피드백 모드)의 약자
  - OFB 모드에서는 암호 알고리즘의 출력을 암호 알고리즘의 입력으로 피드백
  - 평문 블록은 암호 알고리즘에 의해 직접 암호화되고 있는 것이 아님
  - [평문 블록]과 [암호 알고리즘의 출력]을 XOR 해서 [암호문 블록]을 만듦 (CFB와 비슷)

![57](/assets/images/2024-04-14/57.png)

### 5.2 초기화 벡터

- CBC 모드나 CFB 모드와 마찬가지로 초기화 벡터(IV)를 사용

- 초기화 벡터는 암호화 때마다 다른 랜덤 비트열을 이용

![58](/assets/images/2024-04-14/58.png)

![59](/assets/images/2024-04-14/59.png)

## 제 6 절 CTR 모드

### CTR 모드

- CounTeR 모드의 약자

- CTR 모드는 1씩 증가해 가는 카운터를 암호화해서 키 스트림을 만들어 내는 스트림 암호

- 블록을 암호화할 때마다 1씩 증가해가는 카운터를 암호화해서 키 스트림을 만든다

### 6.1 카운터 만드는 법

- 카운터 초기값

  - 암호화 때마다 다른 값(nonce, 비표)을 기초로 해서 작성
  - 예) 블록의 길이 128비트 (16바이트)

  ![60](/assets/images/2024-04-14/60.png)

![61](/assets/images/2024-04-14/61.png)

![62](/assets/images/2024-04-14/62.png)

### 6.3 CTR 모드의 특징

- CTR 모드의 암호화와 복호화는 완전히 같은 구조

- 프로그램으로 구현하는 것이 매우 간단

- OFB 모드와 같은 스트림 암호의 특징을 가짐

- CTR 모드에서는 블록을 임의의 순서로 암호화, 복호화할 수 있음

  - 카운터는 비표와 블록번호로부터 신속하게 구할 수 있기 때문

- 병렬 처리가 가능한 시스템에서는 CTR 모드를 이용하여 자료를 고속으로 처리가 가능

### 6.4 오류와 기밀성

- CTR 모드의 암호문 블록에서 1비트의 반전이 발생

  - 복호화를 수행하면, 반전된 비트에 대응하는 평문 블록의 1비트만이 반전되고, 오류는 확대되지 않음

- OFB 모드에서는
  - 키 스트림의 1블록을 암호화한 결과가 암호화전의 결과와 우연히 같아졌다고 하면
  - 그 이후 키 스트림은 완전히 같은 값이 반복 (CTR 모드의 차별된 성질)
  - CTR 모드에서는 그런 걱정은 없음

### 6.5 모드 선택

- ECB 모드 (Electric CodeBook 전자 부호표 모드)

  - 장점
    - 간단, 고속, 병렬 처리 가능(암호화, 복호화 양쪽)
  - 단점
    - 평문 속의 반복이 암호문에 반영된다.
    - 암호문 블록의 삭제나 교체에 의한 평문의 조작이 가능
    - 비트 단위의 에러가 있는 암호문을 복호화하면, 대응하는 블록이 에러가 된다.
    - 재전송 공격이 가능
  - 비고
    - 사용하지 않는 것을 권장

- CBC 모드 (Cipher Block Chaining 암호 블록 연쇄 모드)

  - 장점
    - 평문의 반복은 암호문에 반영되지 않는다.
    - 병렬 처리 가능 (복호화만)
    - 임의의 암호문 블록을 복호화할 수 있다.
  - 단점
    - 비트 단위의 에러가 있는 암호문을 복호화하면, 1블록 전체와 다음 블록의 대응하는 비트가 에러가 된다.
    - 암호화에서는 병렬 처리를 할 수 없다.
  - 비고
    - 권장

- CFB 모드 (Cipher-FeedBack 암호 피드백 모드)

  - 장점
    - 패딩이 필요 없다.
    - 병렬 처리 가능(복호화만)
    - 임의의 암호문 블록을 복호화할 수 있다.
  - 단점
    - 암호화에서는 병렬 처리를 할 수 없다.
    - 비트 단위의 에러가 있는 암호문을 복호화하면, 1블록 전체와 다음 블록의 대응하는 비트가 에러가 된다.
    - 재전송 공격이 가능

- OFB 모드 (Output-FeedBack 출력 피드백 모드)

  - 장점
    - 패딩이 필요 없다.
    - 암호화, 복호화의 사전 준비를 할 수 있다.
    - 암호화와 복호화가 같은 구조를 하고 있다.
    - 비트 단위의 에러가 있는 암호문을 복호화하면, 평문의 대응하는 비트만 에러가 된다.
  - 단점
    - 병렬 처리를 할 수 없다.
    - 적극적 공격자가 암호문 블록을 비트 반전시키면, 대응하는 평문 블록이 비트 반전된다.

- CTR 모드 (CounTeR 카운터 모드)
  - 장점
    - 패딩이 필요 없다.
    - 암호화, 복호화의 사전 준비를 할 수 있다.
    - 암호화와 복호화가 같은 구조를 하고 있다.
    - 비트 단위의 에러가 있는 암호문을 복호화하면, 평문의 대응하는 비트만 에러가 된다.
    - 병렬 처리가능 (암호화, 복호화 양쪽)
  - 단점
    - 적극적 공격자가 암호문 블록을 비트 반전시키면, 대응하는 평문 블록이 비트 반전된다.
  - 비고
    - 권장

### CFB, OFB, CTR 모드에서 패딩이 필요없는 이유

- CFB 모드

  - 암호화된 이전 블록의 결과가 다음 블록의 암호화에 사용됨
  - 이전 블록의 암호문은 현재 블록의 입력으로 사용되므로, 데이터가 블록 크기의 배수가 아닌 경우에도 암호화가 가능

- OFB 모드

  - 암호화된 출력이 다음 블록의 입력으로 사용
  - OFB에서는 암호화된 출력만 사용되므로, 입력의 크기가 블록 크기의 배수가 아니더라도 패딩이 필요하지 않음

- CTR 모드

  - 블록 암호 함수를 사용하여 카운터 값을 암호화한 다음, 평문과 XOR하여 암호문을 생성
  - 이 과정에서 암호화된 출력은 평문과 동일한 길이를 갖기 때문에 패딩이 필요하지 않음
  - 이러한 특성은 데이터의 크기가 가변적이고 실시간 처리에 유용함

- 주의 사항
  - CFB 및 OFB 모드는 평문의 길이가 블록 크기의 배수가 아니더라도 사용할 수 있지만,
  - 암호화된 결과는 항상 블록 크기의 배수가 되므로 복호화시 패딩이 필요하지 않더라도
  - 암호문의 길이가 블록 크기의 배수가 되도록 조정이 필요함

### CTS 모드

- CTS(Cipher Text Stealing) 모드

- 마지막 블록 한 단계 전의 암호화 블록을 패딩으로 대신 이용

- ECB나 CBC 모드와 조합해 사용

- 마지막 블록을 송신하는 순서를 변경하는 변형된 형태로도 운영

- CBC-CS1, CBC-CS2, CBC-CS3

![63](/assets/images/2024-04-14/63.png)

### GCM 모드

- GCM (Galois / Counter Mode)

- CTR 모드에 인증 기능을 추가한 모드

- CTR 모드로 암호문과 인증자를 생성

- 암호문 위조를 탐지할 수 있음

- 암호화 입력: 암호키, 평문, Nonce 및 부가 인증 데이터 (ADD)

- 암호화 출력: 암호문과 인증값 (tag)

- 복호화 입력: 암호문, 암호키, Nonce, ADD

### CCM 모드

- CCM 모드(Counter with CBC-MAC)

- 카운터 모드(Counter mode)와 CBC-MAC(Cipher Block Chaining - Message Authentication Code)의 기능 결합한 운영 모드

- 메세지의 기밀성과 인증 기능을 동시에 제공

### 관련 데이터로 인증된 암호 방식(AEAD)

- Authenticated Encryption with Associated Data: AEAD

  - CCM mode
  - GCM

  - CWC(Carter-Wegman + CTR mode) mode
  - OCB mode(Offsetest CodeBook)
  - EAX mode(Encrypt-then-Authenticate-then-Translate)
  - SGCM(Sophie Germain Counter Mode)
  - Signcryption
